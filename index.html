<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>tasuku-App | Kii's Secretary</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/lucide-react@latest"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        const { 
            Plus, Trash2, CheckCircle2, Circle, Calendar, Star, Send, Clipboard, Bell, Layers,
            Sparkles, MessageSquare, Settings, X, Zap, History, Cloud, Target, Pin,
            ChevronRight, ExternalLink, Edit3, Bookmark, Layout, Activity, TrendingUp,
            AlertCircle, Lightbulb, Link2, Clock, Search, Globe
        } = lucide;

        // --- Ë®≠ÂÆö„Ç®„É™„Ç¢ ---
        // Firebase„ÅÆ„Ç≥„É≥„ÇΩ„Éº„É´„Åã„ÇâÂèñÂæó„Åó„ÅüË®≠ÂÆö„Çí„Åì„Åì„Å´Ë≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        
        const GEMINI_API_KEY = "YOUR_GEMINI_API_KEY"; // Gemini API„Ç≠„Éº„Çí„Åì„Åì„Å´ÂÖ•Âäõ
        const appId = 'kii-ultimate-stable-workspace-v1';
        // ----------------

        // Firebase SDK„ÅÆÂãïÁöÑ„Ç§„É≥„Éù„Éº„ÉàÔºàCDNÁî®Ôºâ
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const App = () => {
            const [user, setUser] = useState(null);
            const [tasks, setTasks] = useState([]);
            const [userInput, setUserInput] = useState("");
            const [isProcessing, setIsProcessing] = useState(false);
            const [notificationMsg, setNotificationMsg] = useState(null);
            const [showSummary, setShowSummary] = useState(false);
            const [advice, setAdvice] = useState("Kii„Åï„Çì„ÄÅ„Çø„Çπ„ÇØ„ÇíÂàÜÊûê„Åó„Å¶Êà¶Áï•„ÇíÁ´ã„Å¶„Å¶„ÅÑ„Åæ„Åô...");
            const [isGeneratingAdvice, setIsGeneratingAdvice] = useState(false);
            
            const [announcementTime, setAnnouncementTime] = useState("18:00");
            const [isReminderActive, setIsReminderActive] = useState(true);
            const [slackWebhookUrl, setSlackWebhookUrl] = useState("");
            const [showSettings, setShowSettings] = useState(false);
            const lastTriggeredRef = useRef(null);

            useEffect(() => {
                signInAnonymously(auth).catch(err => console.error("Auth Error:", err));
                const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
                    setUser(currentUser);
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user) return;
                const tasksCollection = collection(db, 'artifacts', appId, 'users', user.uid, 'tasks');
                const unsubscribeTasks = onSnapshot(tasksCollection, (snapshot) => {
                    const tasksData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setTasks(tasksData);
                });

                const settingsDoc = doc(db, 'artifacts', appId, 'users', user.uid, 'config', 'user_settings');
                const unsubscribeSettings = onSnapshot(settingsDoc, (snapshot) => {
                    if (snapshot.exists()) {
                        const data = snapshot.data();
                        if (data.announcementTime) setAnnouncementTime(data.announcementTime);
                        if (data.isReminderActive !== undefined) setIsReminderActive(data.isReminderActive);
                        if (data.slackWebhookUrl) setSlackWebhookUrl(data.slackWebhookUrl);
                    }
                });

                return () => {
                    unsubscribeTasks();
                    unsubscribeSettings();
                };
            }, [user]);

            const extractUrl = (text) => {
                if (!text || typeof text !== 'string') return null;
                const urlRegex = /(https?:\/\/[^\s]+)/g;
                const matches = text.match(urlRegex);
                return matches ? matches[0] : null;
            };

            const generateEfficiencyAdvice = async (currentTasks) => {
                const activeTasks = currentTasks.filter(t => !t.completed);
                if (activeTasks.length === 0) {
                    setAdvice("‚úÖ Kii„Åï„Çì„ÄÅÂÖ®„Éü„ÉÉ„Ç∑„Éß„É≥ÂÆå‰∫Ü„Åß„Åô„ÄÇÊòéÊó•„ÅÆ„Åü„ÇÅ„Å´„É™„É©„ÉÉ„ÇØ„Çπ„Åó„Åæ„Åó„Çá„ÅÜÔºÅ");
                    return;
                }
                setIsGeneratingAdvice(true);
                
                const systemPrompt = `„ÅÇ„Å™„Åü„ÅØKii„Åï„Çì„ÅÆÂ∞ÇÂ±ûÁßòÊõ∏„Åß„Åô„ÄÇ‰∏ÄÁû¨„ÅßÊääÊè°„Åß„Åç„Çã„Çà„ÅÜ„ÄÅüéØÊúÄÂÑ™ÂÖà„ÄÅüöÄÂäπÁéáÂåñ„ÄÅ‚ö†Ô∏è„É™„Çπ„ÇØ„ÅÆ3È†ÖÁõÆ„Åß„Ç¢„Éâ„Éê„Ç§„Çπ„Åó„Å¶„ÄÇÂêÑ1Ë°å„ÄÅË®à3Ë°å„ÄÇ`;

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: `„Çø„Çπ„ÇØ„É™„Çπ„Éà: ${JSON.stringify(activeTasks)}` }] }],
                            systemInstruction: { parts: [{ text: systemPrompt }] }
                        })
                    });
                    const data = await response.json();
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (text) setAdvice(text.trim());
                } catch (err) {
                    console.error("Advice Error:", err);
                } finally {
                    setIsGeneratingAdvice(false);
                }
            };

            useEffect(() => {
                if (tasks.length > 0) {
                    const timer = setTimeout(() => generateEfficiencyAdvice(tasks), 2000); 
                    return () => clearTimeout(timer);
                }
            }, [tasks.length, tasks.filter(t => t.completed).length]);

            const processMessageWithAI = async (message) => {
                if (!message.trim() || !user) return;
                setIsProcessing(true);
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: message }] }],
                            systemInstruction: { parts: [{ text: `„Çø„Çπ„ÇØËøΩÂä†(add)„ÉªÊõ¥Êñ∞(update)„ÇíÂà§Êñ≠„Åó„ÄÅ{"actions": [{"type": "add", "data": {"text": "...", "project": "..."}}]} „ÅÆ„Çà„ÅÜ„Å™JSON„ÅßÂá∫Âäõ„Åó„Å¶„ÄÇ` }] },
                            generationConfig: { responseMimeType: "application/json" }
                        })
                    });
                    const data = await response.json();
                    const result = JSON.parse(data.candidates[0].content.parts[0].text);
                    const tasksCollection = collection(db, 'artifacts', appId, 'users', user.uid, 'tasks');
                    if (result.actions) {
                        for (const action of result.actions) {
                            if (action.type === 'add') {
                                await addDoc(tasksCollection, { ...action.data, completed: false, createdAt: new Date().toISOString() });
                            }
                        }
                        triggerNotification("ÂèçÊò†„Åó„Åæ„Åó„Åü„ÄÇ");
                    }
                    setUserInput("");
                } catch (error) {
                    triggerNotification("Ëß£ÊûêÂ§±Êïó„ÄÇ");
                } finally {
                    setIsProcessing(false);
                }
            };

            const triggerNotification = (msg) => {
                setNotificationMsg(msg);
                setTimeout(() => setNotificationMsg(null), 3000);
            };

            const toggleTask = async (task) => {
                const taskDoc = doc(db, 'artifacts', appId, 'users', user.uid, 'tasks', task.id);
                await updateDoc(taskDoc, { completed: !task.completed });
            };

            const deleteTask = async (id) => {
                const taskDoc = doc(db, 'artifacts', appId, 'users', user.uid, 'tasks', id);
                await deleteDoc(taskDoc);
            };

            const processedData = useMemo(() => {
                const today = tasks.filter(t => t.isToday && !t.completed);
                const projects = tasks.reduce((acc, task) => {
                    const p = task.project || '„Åù„ÅÆ‰ªñ';
                    if (!acc[p]) acc[p] = [];
                    acc[p].push(task);
                    return acc;
                }, {});
                return { today, projects };
            }, [tasks]);

            const copyToClipboard = (text) => {
                navigator.clipboard.writeText(text);
                triggerNotification("„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü„ÄÇ");
            };

            // JSX UI („Éá„Ç∂„Ç§„É≥„ÇíÁ∂≠ÊåÅ)
            return (
                <div className="min-h-screen bg-[#F8FAFC] p-4 md:p-8 pb-32 font-sans text-slate-900">
                    <style>{`
                        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap');
                        body { font-family: 'Noto Sans JP', sans-serif; }
                    `}</style>
                    
                    {notificationMsg && (
                        <div className="fixed top-6 right-6 bg-slate-900 text-white px-6 py-3 rounded-2xl shadow-xl z-[100] flex items-center gap-3">
                            <Zap size={16} className="text-yellow-400" />
                            <span className="font-bold text-xs">{notificationMsg}</span>
                        </div>
                    )}

                    <div className="max-w-3xl mx-auto">
                        <header className="flex justify-between items-center mb-8">
                            <h1 className="text-2xl font-black italic">Kii's <span className="text-indigo-600">Secretary</span></h1>
                            <button onClick={() => setShowSettings(true)} className="p-2 border rounded-xl bg-white"><Settings size={20} /></button>
                        </header>

                        <div className="bg-indigo-600 rounded-[32px] p-8 mb-10 text-white shadow-xl">
                            <div className="text-[10px] font-bold opacity-70 mb-4 uppercase tracking-widest">Strategy Advice</div>
                            <div className="space-y-2 text-lg font-bold whitespace-pre-wrap">
                                {isGeneratingAdvice ? "ÂàÜÊûê‰∏≠..." : advice}
                            </div>
                        </div>

                        <div className="bg-white rounded-[32px] p-8 mb-16 shadow-sm border border-slate-100">
                            <textarea 
                                value={userInput}
                                onChange={(e) => setUserInput(e.target.value)}
                                className="w-full h-24 text-lg outline-none resize-none"
                                placeholder="„Çø„Çπ„ÇØ„ÇíÂÖ•Âäõ..."
                            />
                            <div className="flex justify-end mt-4">
                                <button onClick={() => processMessageWithAI(userInput)} className="bg-slate-900 text-white px-8 py-2 rounded-2xl font-bold">
                                    {isProcessing ? "ÂÆüË°å‰∏≠..." : "ÂèçÊò†„Åô„Çã"}
                                </button>
                            </div>
                        </div>

                        <h2 className="text-xl font-black mb-6">TODAY'S TASKS</h2>
                        <div className="space-y-4">
                            {tasks.map(task => (
                                <div key={task.id} className="flex items-center gap-4 p-4 bg-white rounded-2xl border">
                                    <button onClick={() => toggleTask(task)}>
                                        {task.completed ? <CheckCircle2 className="text-emerald-500" /> : <Circle className="text-slate-300" />}
                                    </button>
                                    <span className={`flex-1 font-bold ${task.completed ? 'line-through text-slate-400' : ''}`}>
                                        {task.text}
                                    </span>
                                    <button onClick={() => deleteTask(task.id)} className="text-slate-300 hover:text-red-500">
                                        <Trash2 size={18} />
                                    </button>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
